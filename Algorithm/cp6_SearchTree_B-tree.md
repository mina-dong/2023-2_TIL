# B-tree 비트리 

## backgorund
- 디스크에 접근하는 시간 >>>  메인메모리접근
- 디스크 읽기/쓰기시 블록단위로 접근
- 블럭 8k (8192btye) / 16K(16384)
- 블록을 소프트웨어 레벨에서는 페이지 page라고 함
- 데이터 한 블록을 읽으려면 20만 클록이 필요함. 기계어 명령처리에는 2클록도 소모되지 않음.
- 원하는 부분을 가져올 수 없고, 한 블록씩 가져올 수 있다.
  
즉, 비트리는 연산 하나를 덜 하는거 보다 차라리 디스크 접근을 줄이는게 더 효율적임.  

### 검색트리가 방대하면?
- 검색트리를 메모리에 올려놓고 사용할수가 없음 -> 디스크에 올려놓고 작업
- 검색트리의 분기수를 늘리면, 기대 깊이를 낮출 수 있음.
- 분기 : 부모가 가질 수 있는 자녀의 수.

만약, 10억개의 키를 다룬다면..  
1) 이진트리라면 깊이가 30
2) 256개의 분기를 가진다면, 깊이가 5

- 검색트리가 디스크에 있는 상태에서 사용되면, 외부검색트리

## B-tree 란?
디스크 환경에서 사용하기 적합한 외부 다진 검색트리(다진검색트리란? 분기가 2가 넘는 트리)

## b-tree 성질
- 루트를 제외한 모든 노드는 k/2~k개의 키를 갖음
- 모든 리프노드는 같은 깊이를 갖음
- 분기의 수는 가능한 늘리되, 각 노드가 채울수 있는 **최대허용량의 반이상**의 키를 채우도록 하는 검색 트리

## b-tree 노드
- k값은 키의 크기, 분기를 위한 포인터에 필요한 공간을 반영함.
- 최대한 디스크 한 블록이 수용할 수 있는 크기를 잡음

예) 디스크 한블록:  8192 바이트 / 키: 16바이트 / 페이지번호 4바이트  
=> (8192-4) / (16+4+4) = 약 341개  
=> 최대 341개의 키 값을 가질 수 있다.  

**최대 허용량의 반이상을 채워야하기 때문에** 노드는 170개~341개의 키를 가질 수 있음.  
블록(페이지) 단위로 읽어오기 때문에, 최대 효율을 위함. 

## b-tree 접근
<key_0, p_0> // p는 페이지의 포인터이므로, 페이지 번호를 사용함.  (블록 = 페이지)

- p를 이용해 p를 통째로 메인 메모리에 가지고 옴.
- 그 후 해당 레코드를 찾아서 처리(레코드:개체에 대해 수집된 모든 정보를 포함하고 있는 저장 단위)

## b-tree 검색
- 이진트리 검색과 같음 / 이진트리는 각 노드의 키가 하나 밖에 없지만, 비트리는 최대 k까지 가질 수 있음.

## b-tree 삽입
- 키 x를 삽입할 리프노드 r을 찾음
- 노드 r에 공간여유가 있다면, 삽입하고 종료.
- 노드 r에 공간여유가 없다면, 형제노드를 확인하고 형제노드에 키를 하나 넘기고 종류.
- 형제 노드에 여유가 없다면, 키를 부모노드에 넘기고 노드를 두개로 분리함.
이때, 분리작업은 부모노드의 삽입작업을 포함.

## b-tree 삭제
- x를 키로 갖고 있는 노드를 찾음
- 이 노드가 리프노드가 아니라면,  x의 직후원소 y를 가진 리프노드 r을 찾아 x,y을 바꿈.
- 리프노드에서 x 제거
- x제거 후 노드에 언더플로우가 발생하면 해소함.

## b-tree 작업 성능 분석
- 다진 검색트리가 균형을 아주 잘 맞추면 높이가 log_d_n에 근접함.  
- 임의의 노드가 최대 d개의 자식을 가질 수 있다면, 루트를 제외하고 최소 d/2개의 자식을 가져야함.
- 최악의 경우여도 대략 log_d/2 N보다 깊을 수 는 없음.
- 따라서 log_d_n ~log_d/2 N의 사이의 어떤 값임.
- **비트리의 작업 수행시간은 디스크의 접근 횟수를 기준으로함**

## b-tree 작업 성능 
검색 O(logn)  
삽입 O(logn)   
  > 실패하는 검색 한번 수행 O(logn)임.오버플로가 발생하지 않으면 삽입하는데 상수시간. 오버플로가 발생해서 최악의 경우 루트노드까지 파급되면 높이에 비례하는 시간이 들지만, 이것도 O(logn)임.

검색과 오버플로 처리를 합하면 삽입 작업은 O(logn)이다. 


다차원트리 multidimensional search tree 
- kd-tree
- kdb-tree
- r-tree
- grid-file(다차원 검색 방법 중 하나임)